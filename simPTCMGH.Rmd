---
title: "Simulating from a promotion-time cure rate model"
author: '[Francisco Javier Rubio](https://sites.google.com/site/fjavierrubio67/)'
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  html_document:
    toc: true
    toc_float: true
bibliography: references.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Promotion Time Cure Models

Promotion-Time Cure Models (PTCM) are a type of survival (regression) models where a portion of the population is assumed to be cured, or to never experience the time-to-event. That is, there is a sub-population with infinite survival times. The survival function of a PTCM is given by

$$
S_c(t) = \exp\left\{ -\theta \tilde{F}(t) \right\}, \quad t \geq 0,
$$
where $\theta>0$ is a positive parameter, and $\tilde{F}$ is a cumulative distribution function with support on ${\mathbb R}_+$. Note that 

$$
\lim_{t\to\infty} S_c(t) = \exp\{-\theta\},
$$
which represents the cured fraction. Since the survival function associated with the PTCM does not decrease to zero, it is often referred to as an ``improper'' survival function [@peng:2021]. 

If a covariates ${\bf x} \in {\mathbb R}^p$ are available, these can be incorporated into the two different components of the PTCM.

1. Let ${\bf w} \subseteq {\bf x}$, and consider the log-link $\theta({\bf w}) = \exp({\bf w}^{\top}{\boldsymbol{\alpha}})$.

2. Let ${\bf z} \subseteq {\bf x}$, and consider the hazard structure $\tilde{H}(t \mid {\bf z})$. Then, we can define 

$$
\tilde{F}(t \mid {\bf z}) = 1 - \exp\{-\tilde{H}(t \mid {\bf z})\}.
$$
The hazard structure can include the proportional hazards, the accelerated failure time, or more general hazard structures @rubio:2019.

The following R code presents an implementation of the simulation of survival times from a PTCM with proportional hazards, accelerated failure time, and general hazard structures coupled with a log-link for $\theta$.


## Proportional Hazards

Suppose that the hazard and cumulative hazard follow a proportional hazards (PH) structure:

\begin{align}
\tilde{h}(t \mid {\bf z}) &= \tilde{h}_0(t \mid \boldsymbol{\gamma}) \exp\{{\bf z}^{\top} \boldsymbol{\beta}\}, \\
\tilde{H}(t \mid {\bf z}) &= \tilde{H}_0(t \mid \boldsymbol{\gamma}) \exp\{{\bf z}^{\top} \boldsymbol{\beta}\},
\end{align}

where $\tilde{h}_0$ is a baseline hazard associated with a distribution $\tilde{F}_0$, with parameters $\boldsymbol{\gamma}$. Let also $\theta({\bf w}) = \exp({\bf w}^{\top}{\boldsymbol{\alpha}})$, and $u$ be a realisation from a $U(0,1)$ distribution. Then, a simulation from the PTCM model with PH structure (PTCM-PH) can be obtained as:

$$
t^* = \tilde{F}_0^{-1}\left( 1 - \exp\left\{ \exp\left\{ - {\bf z}^{\top}\boldsymbol{\beta} \right\}\log\left[ 1 + \log(u)\exp\left\{-\alpha_0 - {\bf w}^{\top}\boldsymbol{\alpha}  \right\} \right] \right\}  \right).
$$
if $1 + \log(u)\exp\left\{-\alpha_0 - {\bf w}^{\top}\boldsymbol{\alpha}  \right\}>0$, and $t^*=\infty$ otherwise.


## Accelerated Failure Time

Suppose that the hazard and cumulative hazard follow an accelerated failure time (AFT) hazard structure:

\begin{align}
\tilde{h}(t \mid {\bf z}) &= \tilde{h}_0(t \exp\{{\bf z}^{\top} \boldsymbol{\beta}\} \mid \boldsymbol{\gamma}) \exp\{{\bf z}^{\top} \boldsymbol{\beta}\}, \\
\tilde{H}(t \mid {\bf z}) &= \tilde{H}_0(t \exp\{{\bf z}^{\top} \boldsymbol{\beta}\} \mid \boldsymbol{\gamma}) ,
\end{align}

where $\tilde{h}_0$ is a baseline hazard associated with a distribution $\tilde{F}_0$, with parameters $\boldsymbol{\gamma}$. Let also $\theta({\bf w}) = \exp({\bf w}^{\top}{\boldsymbol{\alpha}})$, and $u$ be a realisation from a $U(0,1)$ distribution. Then, a simulation from the PTCM model with PH structure (PTCM-AFT) can be obtained as:

$$
t^* = \tilde{F}_0^{-1}\left( -\log(u) \exp\left\{-\alpha_0 - {\bf w}^{\top}\boldsymbol{\alpha}  \right\} \right)  \exp\left\{ - {\bf z}^{\top}\boldsymbol{\beta} \right\}.
$$
if $\log(u)\exp\left\{-\alpha_0 - {\bf w}^{\top}\boldsymbol{\alpha}  \right\} < 1$, and $t^*=\infty$ otherwise.

## General Hazards

Suppose that the hazard and cumulative hazard follow a General Hazard (GH) structure [@chen:2001] [@rubio:2019]:

\begin{align}
\tilde{h}(t \mid {\bf z}) &= \tilde{h}_0(t \exp\{{\bf z}^{\top} \boldsymbol{\eta}\} \mid \boldsymbol{\gamma}) \exp\{{\bf z}^{\top} \boldsymbol{\beta}\}, \\
\tilde{H}(t \mid {\bf z}) &= \tilde{H}_0(t \exp\{{\bf z}^{\top} \boldsymbol{\eta}\} \mid \boldsymbol{\gamma})  \exp\{{\bf z}^{\top} \boldsymbol{\beta} - {\bf z}^{\top} \boldsymbol{\eta}\}\},
\end{align}

where $\tilde{h}_0$ is a baseline hazard associated with a distribution $\tilde{F}_0$, with parameters $\boldsymbol{\gamma}$. Let also $\theta({\bf w}) = \exp({\bf w}^{\top}{\boldsymbol{\alpha}})$, and $u$ be a realisation from a $U(0,1)$ distribution. Then, a simulation from the PTCM model with PH structure (PTCM-AFT) can be obtained as:

$$
t^* = \exp\left\{ - {\bf z}^{\top}\boldsymbol{\eta} \right\} \tilde{F}_0^{-1}\left( 1 - \exp\left\{ \exp\left\{ {\bf z}^{\top}\boldsymbol{\eta}  - {\bf z}^{\top}\boldsymbol{\beta} \right\}\log\left[ 1 + \log(u)\exp\left\{-\alpha_0 - {\bf w}^{\top}\boldsymbol{\alpha}  \right\} \right] \right\}  \right).
$$
if $1 - \exp\left\{ \exp\left\{ {\bf z}^{\top}\boldsymbol{\eta}  - {\bf z}^{\top}\boldsymbol{\beta} \right\}\log\left[ 1 + \log(u)\exp\left\{-\alpha_0 - {\bf w}^{\top}\boldsymbol{\alpha}  \right\} \right] \right\} < 1$, and $t^*=\infty$ otherwise.

# A general simulation strategy

Provided that one can simulate from the distribution $\tilde{F}(t \mid {\bf z})$ using numerical methods, simulating from a PTCM can be done simply by simulating $u\sim U(0,1)$, and solving

$$
t^* = \tilde{F}\left( -\log(u) \exp\left\{-\alpha_0 - {\bf w}^{\top}\boldsymbol{\alpha}  \right\} \mid {\bf z} \right)
$$
if $-\log(u) \exp\left\{-\alpha_0 - {\bf w}^{\top}\boldsymbol{\alpha}  \right\} < 1$, and $t^*=\infty$ otherwise.

# R code

## Simulation

```{r}

rm(list=ls())


library(HazReg)

source("routines.R")

n = 1000
seed = 123
set.seed(seed)
des0 <- cbind(1, rnorm(n), rnorm(n))


sim = simPTCMGH(n = n,
          seed = seed,
          hstr = "AFT",
          dist = "LogNormal",
          des_theta = des0,
          des_t = NULL,
          des_h = NULL,
          des = des0[, -1],
          par_base = c(-0.25, 0.1),
          alpha = c(0.5, 0.5, 0.5),
          beta_t = NULL,
          beta_h = NULL,
          beta = c(0.5, 0.5))


cens = 4
status <- ifelse(sim < cens, 1, 0)
mean(status)

times <- ifelse(sim< cens, sim, cens)

library(survival)
# Kaplan-Meier estimator for the survival times
km <- survfit(Surv(times, status) ~ 1)

plot(km$time, km$surv, type = "l", col = "black", lwd = 2, lty = 1, 
     ylim = c(0,1), xlab = "Time", ylab = "Survival")

```

## Model fit: baseline


```{r}

OPT <- PTCMMLE(init = c(0,0,0),
                    times = times,
                    status = status,
                    hstr = "baseline",
                    dist = "LogNormal",
                    des_theta = NULL,
                    des_t = NULL,
                    des_h = NULL,
                    des = NULL,
                    method = "nlminb", 
                    maxit = 10000) 


MLE <- c(OPT$OPT$par[1],exp(OPT$OPT$par[2]),exp(OPT$OPT$par[3]))

spt <- Vectorize(function(t) exp(- MLE[3]*(1-exp(-chlnorm(t,MLE[1],MLE[2])))) )

plot(km$time, km$surv, type = "l", col = "black", lwd = 2, lty = 1, 
     ylim = c(0,1), xlab = "Time", ylab = "Survival")
curve(spt,0,4, col = "red", add= T) 
```

## Model fit: PH

```{r}
OPT_PH <- PTCMMLE(init = c(0,0,0,0,0,0,0),
               times = times,
               status = status,
               hstr = "PH",
               dist = "LogNormal",
               des_theta = des0,
               des_t = NULL,
               des_h = NULL,
               des = des0[,-1],
               method = "nlminb", 
               maxit = 10000) 


MLE_PH <- c(OPT_PH$OPT$par[1],exp(OPT_PH$OPT$par[2]),OPT_PH$OPT$par[-c(1:2)])

spt_ph <- Vectorize(function(t){
  
  theta_i <- as.vector(exp(des0 %*% MLE_PH[3:5]))
  F_i <- 1 - exp(-chlnorm(t,MLE_PH[1],MLE_PH[2])*exp(des0[,-1]%*%MLE_PH[6:7]))
  survs <- exp(-theta_i*F_i)
  return(mean(survs))
  }) 

plot(km$time, km$surv, type = "l", col = "black", lwd = 2, lty = 1, 
     ylim = c(0,1), xlab = "Time", ylab = "Survival")
curve(spt_ph,0,4, col = "red", add= T)  
```

# Model fit: AFT


```{r}
OPT_AFT <- PTCMMLE(init = c(0,0,0,0,0,0,0),
                  times = times,
                  status = status,
                  hstr = "AFT",
                  dist = "LogNormal",
                  des_theta = des0,
                  des_t = NULL,
                  des_h = NULL,
                  des = des0[,-1],
                  method = "nlminb", 
                  maxit = 10000) 


MLE_AFT <- c(OPT_AFT$OPT$par[1],exp(OPT_AFT$OPT$par[2]),OPT_AFT$OPT$par[-c(1:2)])

cbind(MLE_AFT, c(-0.25, 0.1,0.5, 0.5, 0.5,0.5, 0.5))


spt_aft <- Vectorize(function(t){
  
  theta_i <- as.vector(exp(des0 %*% MLE_AFT[3:5]))
  F_i <- 1 - exp(-chlnorm(as.vector(t*exp(des0[,-1]%*%MLE_AFT[6:7])),MLE_AFT[1],MLE_AFT[2]))
  survs <- exp(-theta_i*F_i)
  return(mean(survs))
}) 




plot(km$time, km$surv, type = "l", col = "black", lwd = 2, lty = 1, 
     ylim = c(0,1), xlab = "Time", ylab = "Survival")
curve(spt_aft,0,4, col = "red", add= T)  
```


# Model fit: Accelerated Hazards

```{r}
OPT_AH <- PTCMMLE(init = c(0,0,0,0,0,0,0),
                   times = times,
                   status = status,
                   hstr = "AH",
                   dist = "LogNormal",
                   des_theta = des0,
                   des_t = des0[,-1],
                   des_h = NULL,
                   des = NULL,
                   method = "nlminb", 
                   maxit = 10000) 


MLE_AH <- c(OPT_AH$OPT$par[1],exp(OPT_AH$OPT$par[2]),OPT_AH$OPT$par[-c(1:2)])

cbind(MLE_AH, c(-0.25, 0.1,0.5, 0.5, 0.5,0.5, 0.5))


spt_ah <- Vectorize(function(t){
  
  theta_i <- as.vector(exp(des0 %*% MLE_AH[3:5]))
  F_i <- 1 - exp(-chlnorm(as.vector(t*exp(des0[,-1]%*%MLE_AH[6:7])),MLE_AH[1],MLE_AH[2])*as.vector(exp(-des0[,-1]%*%MLE_AH[6:7])))
  survs <- exp(-theta_i*F_i)
  return(mean(survs))
}) 




plot(km$time, km$surv, type = "l", col = "black", lwd = 2, lty = 1, 
     ylim = c(0,1), xlab = "Time", ylab = "Survival")
curve(spt_ah,0,4, col = "red", add= T)  
```

# Model fit: General Hazards

```{r}
OPT_GH <- PTCMMLE(init = c(0,0,0,0,0,0,0,0,0),
                   times = times,
                   status = status,
                   hstr = "GH",
                   dist = "LogNormal",
                   des_theta = des0,
                   des_t = des0[,-1],
                   des_h = des0[,-1],
                   des = NULL,
                   method = "nlminb", 
                   maxit = 10000) 


MLE_GH <- c(OPT_GH$OPT$par[1],exp(OPT_GH$OPT$par[2]),OPT_GH$OPT$par[-c(1:2)])

cbind(MLE_GH, c(-0.25, 0.1,0.5, 0.5, 0.5,0.5, 0.5, 0.5, 0.5))


spt_gh <- Vectorize(function(t){
  
  theta_i <- as.vector(exp(des0 %*% MLE_GH[3:5]))
  F_i <- 1 - exp(-chlnorm(as.vector(t*as.vector(exp(des0[,-1]%*%MLE_GH[6:7]))),MLE_GH[1],MLE_GH[2])*as.vector(exp(des0[,-1]%*%MLE_GH[8:9] - des0[,-1]%*%MLE_GH[6:7])))
  survs <- exp(-theta_i*F_i)
  return(mean(survs))
}) 




plot(km$time, km$surv, type = "l", col = "black", lwd = 2, lty = 1, 
     ylim = c(0,1), xlab = "Time", ylab = "Survival")
curve(spt_gh,0,4, col = "red", add= T)  
```

## Model comparison

```{r}
AIC <- 2*OPT$OPT$objective + 2*length(OPT$OPT$par)
AIC_PH <- 2*OPT_PH$OPT$objective + 2*length(OPT_PH$OPT$par)
AIC_AFT <- 2*OPT_AFT$OPT$objective + 2*length(OPT_AFT$OPT$par)
AIC_AH <- 2*OPT_AH$OPT$objective + 2*length(OPT_AH$OPT$par)
AIC_GH <- 2*OPT_GH$OPT$objective + 2*length(OPT_GH$OPT$par)

c(AIC, AIC_PH, AIC_AFT, AIC_AH, AIC_GH)
```

# References